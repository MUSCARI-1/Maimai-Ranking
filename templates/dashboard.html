<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>maimai ë‚´ìˆ˜ìš© ë­í‚¹ ë³´ë“œ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Grid.js -->
    <link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { brand: { 50: '#f0f9ff', 500: '#0ea5e9', 900: '#0c4a6e' } },
                    fontFamily: { sans: ['Pretendard', 'sans-serif'] }
                }
            }
        }
    </script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .glass-card {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }
        /* Grid.js Customization */
        .gridjs-container { font-family: 'Pretendard', sans-serif; color: #334155; }
        .gridjs-wrapper { 
            border-radius: 0.75rem; 
            border: none !important; 
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1); 
            /* ê°€ë¡œ ìŠ¤í¬ë¡¤ì„ ë§‰ê³  ìì—°ìŠ¤ëŸ½ê²Œ ì¤„ì–´ë“¤ê²Œ í•¨ */
            overflow-x: hidden !important; 
        }
        .gridjs-table {
            width: 100% !important;
            /* ê¸°ì¡´ì˜ min-width: 550px ë°©ì–´ë§‰ ì‚­ì œ */
        }
        .gridjs-th { background-color: #f1f5f9 !important; font-weight: 600 !important; border-bottom: 2px solid #e2e8f0 !important; }
        .gridjs-td { 
            border: 1px solid #f1f5f9 !important; 
            cursor: pointer; 
            /* ì¢ì€ í™”ë©´ì—ì„œ í…ìŠ¤íŠ¸ê°€ ì…€ì„ ëš«ê³  ë‚˜ê°€ì§€ ì•Šê³  ìì—°ìŠ¤ëŸ½ê²Œ ì¤„ë°”ê¿ˆ ë˜ë„ë¡ í—ˆìš© */
            white-space: normal !important; 
            word-break: break-word !important; 
        }
        .gridjs-tr:hover .gridjs-td { background-color: #f8fafc !important; }

        /* ëª¨ë°”ì¼ ì „ìš© ì—¬ë°±/í°íŠ¸ ìµœì í™” */
        @media (max-width: 640px) {
            .gridjs-th, .gridjs-td {
                padding: 8px 6px !important; /* ì¢ì€ í™”ë©´ì—ì„œ ì—¬ë°± ëŒ€í­ ì¶•ì†Œ */
                font-size: 0.75rem !important; /* ëª¨ë°”ì¼ì—ì„œ í°íŠ¸ ì¶•ì†Œ */
            }
        }
    </style>
</head>
<body class="text-slate-800 antialiased min-h-screen flex flex-col items-center py-10 px-4 sm:px-6 lg:px-8">

    <!-- Header -->
    <div class="w-full max-w-7xl mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h1 class="text-3xl font-bold tracking-tight text-slate-900 flex items-center gap-2">
                <span class="text-4xl">ğŸ‘‘</span> maimai DX ë°©ì–´ì „ í˜„í™©
            </h1>
            <p class="text-slate-500 mt-2 text-sm">ë‚´ìˆ˜ìš© í”„ë¼ì´ë¹— ë­í‚¹ ë° ì ìœ ìœ¨ ë¶„ì„</p>
        </div>
        <div class="flex gap-2">
            <button class="bg-white border border-slate-200 text-slate-600 px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-50 transition shadow-sm">ë‚´ ê¸°ë¡ ê°±ì‹ </button>
        </div>
    </div>

    <!-- Top Widgets -->
    <div class="w-full max-w-7xl grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- User Summary List -->
        <div class="glass-card rounded-2xl p-6 lg:col-span-1 flex flex-col max-h-[400px]">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
                    <span class="text-xl">ğŸ”¥</span> íƒ€ì´í‹€ ì ìœ ìœ¨
                </h2>
            </div>
            <ul class="space-y-3 overflow-y-auto pr-2" id="userSummaryList">
                <!-- Dynamically rendered by JS -->
            </ul>
        </div>

        <!-- Chart Area -->
        <div class="glass-card rounded-2xl p-6 lg:col-span-2 flex flex-col items-center justify-center relative min-h-[400px]">
            <h2 class="absolute top-6 left-6 text-lg font-semibold text-slate-800">ì ìœ ìœ¨ í˜„í™©</h2>
            <p class="absolute top-7 right-6 text-xs text-slate-400 hidden sm:block">ì¡°ê°ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ê³¡ í•„í„°ë§</p>
            <div class="w-full h-72 flex justify-center">
                <canvas id="rankingChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Data Grid -->
    <div class="w-full max-w-7xl glass-card rounded-2xl p-6 shadow-sm">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
            <div>
                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <span class="text-xl">ğŸµ</span> ì „ì²´ ê³¡ ë­í‚¹ ë³´ë“œ
                </h2>
                <p class="text-sm text-slate-500 mt-1">í–‰ì„ í´ë¦­í•˜ë©´ ìƒì„¸ ê¸°ë¡ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            
            <div class="flex items-center gap-3">
                <span id="chartFilterStatus" class="hidden text-sm font-bold text-red-500 cursor-pointer hover:text-red-700 bg-red-50 px-3 py-1.5 rounded-lg transition" onclick="clearChartFilter()">
                    âœ– í•„í„° í•´ì œ
                </span>
                <label for="levelFilter" class="text-sm font-medium text-slate-600 hidden sm:block">ë ˆë²¨ í•„í„°:</label>
                <select id="levelFilter" class="bg-white border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-2 outline-none shadow-sm transition">
                    <option value="all">ì „ì²´ ë ˆë²¨ ë³´ê¸°</option>
                    <!-- Dynamically populated -->
                </select>
            </div>
        </div>
        <div id="gridjs-table-wrapper"></div>
    </div>

    <!-- Modal Area (Tailwind Styled) -->
    <div id="rankingModal" class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 items-center justify-center p-4 transition-opacity" onclick="closeModal(event)">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl flex flex-col overflow-hidden" onclick="event.stopPropagation()">
            <!-- Modal Header -->
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 id="modalTitle" class="font-bold text-xl text-slate-800">ê³¡ ì´ë¦„ (Lv.?) ë­í‚¹</h3>
                <button class="text-slate-400 hover:text-red-500 text-3xl font-light leading-none transition" onclick="closeModal(event)">&times;</button>
            </div>
            <!-- Modal Body -->
            <div class="p-0 overflow-y-auto max-h-[60vh]">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0 shadow-sm">
                        <tr>
                            <th class="px-6 py-4 w-1/4">ìˆœìœ„</th>
                            <th class="px-6 py-4 w-1/2">ìœ ì €</th>
                            <th class="px-6 py-4 w-1/4 text-right">ì ìˆ˜</th>
                        </tr>
                    </thead>
                    <tbody id="modalTableBody" class="divide-y divide-slate-100">
                        <!-- Data fetched via API -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // 1. Flaskì—ì„œ ì£¼ì…ë˜ëŠ” ë°ì´í„°
        const allScores = {{ top_scores_json|safe }};
        
        // --- ìƒíƒœ ë³€ìˆ˜ ---
        let currentLevelFilter = "all";
        let currentChartFilter = "all";
        let myChart = null;
        let gridInstance = null;

        // --- ì´ˆê¸°í™” ë¡œì§ ---
        window.onload = function() {
            // ë°©ì–´ì  ì½”ë“œ: allScoresê°€ ì¡´ì¬í•  ë•Œë§Œ ë ˆë²¨ í•„í„° ìƒì„±
            if (allScores && Array.isArray(allScores) && allScores.length > 0) {
                const levels = new Set(allScores.map(item => String(item.level || ""))); // ëª…ì‹œì  String ìºìŠ¤íŒ…
                const select = document.getElementById("levelFilter");
                
                const sortedLevels = Array.from(levels).sort((a, b) => {
                    const getLevelValue = (lvl) => { let val = parseFloat(lvl); if (lvl.includes('+')) val += 0.5; return val; };
                    return getLevelValue(b) - getLevelValue(a);
                });

                sortedLevels.forEach(lvl => {
                    if(!lvl) return;
                    const option = document.createElement("option");
                    option.value = lvl;
                    option.text = "Level " + lvl;
                    select.appendChild(option);
                });
            }

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë°”ì¸ë”©
            document.getElementById("levelFilter").addEventListener("change", function(e) {
                currentLevelFilter = e.target.value;
                currentChartFilter = "all"; 
                renderDashboard();
            });

            renderDashboard();
        };

        // --- í•µì‹¬ ë Œë”ë§ í•¨ìˆ˜ ---
        function renderDashboard() {
            // ë°©ì–´ì  ì½”ë“œ: ë°ì´í„°ê°€ ì•„ì˜ˆ ì—†ë”ë¼ë„ ë¹ˆ ë°°ì—´ë¡œ ì¹˜í™˜í•˜ì—¬ Grid.jsê°€ 'ë°ì´í„° ì—†ìŒ' UIë¥¼ ê·¸ë¦¬ë„ë¡ ìœ ë„
            const safeScores = (allScores && Array.isArray(allScores)) ? allScores : [];

            // 1ì°¨ í•„í„°: ë ˆë²¨
            let levelFilteredScores = safeScores;
            if (currentLevelFilter !== "all") {
                levelFilteredScores = safeScores.filter(item => String(item.level) === String(currentLevelFilter));
            }

            updateSummaryAndChart(levelFilteredScores);

            // 2ì°¨ í•„í„°: ì°¨íŠ¸/ìœ ì € ìƒí˜¸ì‘ìš©
            let tableScores = levelFilteredScores;
            if (currentChartFilter !== "all") {
                if (currentChartFilter === 'null') {
                    tableScores = tableScores.filter(item => item.user === 'ì—†ìŒ');
                } else if (currentChartFilter === 'tie') {
                    tableScores = tableScores.filter(item => (item.user || "").includes(', '));
                } else if (currentChartFilter.startsWith('user:')) {
                    const u = currentChartFilter.split(':')[1];
                    tableScores = tableScores.filter(item => (item.user || "").split(', ').includes(u));
                } else if (currentChartFilter.startsWith('single:')) {
                    const u = currentChartFilter.split(':')[1];
                    tableScores = tableScores.filter(item => item.user === u);
                } else if (currentChartFilter.startsWith('tie:')) {
                    const u = currentChartFilter.split(':')[1];
                    tableScores = tableScores.filter(item => (item.user || "").includes(', ') && (item.user || "").split(', ').includes(u));
                }
            }

            const filterStatus = document.getElementById("chartFilterStatus");
            if (currentChartFilter === "all") {
                filterStatus.classList.add("hidden");
                filterStatus.classList.remove("inline-block");
            } else {
                filterStatus.classList.remove("hidden");
                filterStatus.classList.add("inline-block");
                let text = "";
                if (currentChartFilter === 'null') text = 'ë¯¸í”Œë ˆì´ ê³¡';
                else if (currentChartFilter === 'tie') text = 'ì „ì²´ ê³µë™ 1ë“± ê³¡';
                else if (currentChartFilter.startsWith('user:')) text = currentChartFilter.split(':')[1] + ' ì „ì²´ 1ë“± ê³¡';
                else if (currentChartFilter.startsWith('single:')) text = currentChartFilter.split(':')[1] + ' ë‹¨ë… 1ë“± ê³¡';
                else if (currentChartFilter.startsWith('tie:')) text = currentChartFilter.split(':')[1] + ' ê³µë™ 1ë“± ê³¡';
                filterStatus.innerHTML = `âœ– [${text}] í•„í„° í•´ì œ`;
            }

            // [ì—ëŸ¬ ë°©ì§€ í•µì‹¬ êµ¬ê°„] Grid.js í˜•ì‹ì— ë§ê²Œ ë°ì´í„° ë³€í™˜ ì‹œ ì—„ê²©í•œ íƒ€ì… êµì •
            const gridData = tableScores.map(row => {
                let parsedScore = parseFloat(row.score);
                if (isNaN(parsedScore)) parsedScore = 0; // NaNì´ Grid.js ì •ë ¬ì„ ë¶•ê´´ì‹œí‚¤ëŠ” ê²ƒ ë°©ì§€

                return [
                    row.song || "Unknown Song", 
                    String(row.level || ""), // ìˆ«ì 14ê°€ ë“¤ì–´ì™€ë„ ë¬´ì¡°ê±´ ë¬¸ìì—´ "14"ë¡œ ìºìŠ¤íŒ…
                    row.user || "ì—†ìŒ", 
                    parsedScore 
                ];
            });

            // Grid.js ë Œë”ë§ ì—ëŸ¬ ë°”ìš´ë”ë¦¬
            try {
                if (!gridInstance) {
                    gridInstance = new gridjs.Grid({
                        columns: [
                            { 
                                name: "ê³¡ ì´ë¦„", 
                                /* ë„ˆë¹„ ë¹„ìœ¨ì„ ë‹¤ì‹œ ì£¼ê³  ì¤„ë°”ê¿ˆ ë°©ì§€ í´ë˜ìŠ¤ë¥¼ ì œê±° */
                                width: '45%' 
                            },
                            { 
                                name: "ë ˆë²¨", 
                                width: '10%',
                                sort: {
                                    compare: (a, b) => {
                                        // ì¸ê°„ì˜ ë„ë©”ì¸ ì§€ì‹(+, - í‹°ì–´)ì„ ì»´í“¨í„°ì˜ ì •ëŸ‰ì  ìˆ˜ì¹˜(.5)ë¡œ ë§¤í•‘í•˜ëŠ” ì»¤ìŠ¤í…€ ë¡œì§
                                        const getLevelValue = (lvl) => {
                                            if (!lvl) return 0;
                                            let val = parseFloat(lvl);
                                            if (isNaN(val)) return 0; // "9", "10" ë¬¸ìì—´ ê¼¬ì„ ë°©ì§€
                                            if (String(lvl).includes('+')) val += 0.5; // +ëŠ” 0.5 ê°€ì¤‘ì¹˜ ë¶€ì—¬
                                            return val;
                                        };
                                        const valA = getLevelValue(a);
                                        const valB = getLevelValue(b);
                                        
                                        // Grid.js ì •ë ¬ ì—”ì§„ì— ê²°ê³¼ê°’ ë°˜í™˜
                                        if (valA > valB) return 1;
                                        if (valA < valB) return -1;
                                        return 0;
                                    }
                                },
                                attributes: (cell) => { 
                                    let baseClass = '';
                                    // if(cell && String(cell).includes('+')) return { 'class': baseClass + 'text-red-500 font-bold' };
                                    return { 'class': baseClass + 'font-medium' }; 
                                }
                            },
                            { 
                                name: "1ë“± ìœ ì €", 
                                width: '25%',
                                formatter: (cell) => gridjs.html(`<span class="${cell === 'ì—†ìŒ' ? 'text-slate-400' : 'text-slate-800 font-semibold'}">${cell}</span>`) 
                            },
                            { 
                                name: "ìµœê³  ì ìˆ˜", 
                                width: '20%',
                                formatter: (cell) => {
                                    // cellì´ ìˆ«ìê°€ ì•„ë‹ ê²½ìš°ì˜ í¬ë§·í„° í¬ë˜ì‹œ ë°©ì§€
                                    const numCell = Number(cell);
                                    return (isNaN(numCell) || numCell === 0) ? '-' : `${numCell.toFixed(4)}%`;
                                }
                            }
                        ],
                        data: gridData,
                        search: { enabled: true, placeholder: "ê³¡ëª… ë˜ëŠ” ìœ ì € ê²€ìƒ‰..." },
                        sort: true,
                        pagination: { enabled: true, limit: 10, summary: true },
                        language: {
                            search: { placeholder: 'ğŸ” ê²€ìƒ‰...' },
                            pagination: { previous: 'ì´ì „', next: 'ë‹¤ìŒ', showing: 'í‘œì‹œì¤‘', results: () => 'ê²°ê³¼' },
                            noRecordsFound: 'í•´ë‹¹í•˜ëŠ” ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.'
                        },
                        className: {
                            table: 'w-full text-sm text-left text-slate-500',
                            thead: 'text-xs text-slate-700 uppercase bg-slate-50',
                            search: 'mb-4 float-left', 
                        }
                    }).render(document.getElementById("gridjs-table-wrapper"));

                    gridInstance.on('rowClick', (...args) => {
                        const row = args[1]; 
                        if(row && row.cells) {
                            openModal(row.cells[0].data, row.cells[1].data);
                        }
                    });
                } else {
                    gridInstance.updateConfig({ data: gridData }).forceRender();
                }
            } catch (error) {
                console.error("Grid.js ë Œë”ë§ ì¹˜ëª…ì  ì˜¤ë¥˜:", error);
                document.getElementById("gridjs-table-wrapper").innerHTML = `
                    <div class="p-6 text-center bg-red-50 rounded-lg border border-red-200">
                        <p class="text-red-600 font-bold">í…Œì´ë¸”ì„ ê·¸ë¦¬ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                        <p class="text-red-400 text-sm mt-1">ë°ì´í„° íƒ€ì… ë¶ˆì¼ì¹˜ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (F12 ì½˜ì†” í™•ì¸ í•„ìš”)</p>
                    </div>`;
            }
        }

        // --- ë¦¬ìŠ¤íŠ¸ í•„í„°ë§ ì—°ë™ ---
        function setListFilter(filterType) {
            if (currentChartFilter === filterType) currentChartFilter = 'all';
            else currentChartFilter = filterType;
            renderDashboard();
        }

        function clearChartFilter() {
            currentChartFilter = "all";
            renderDashboard();
        }

        // --- ìš”ì•½ ë° ì°¨íŠ¸ ë Œë”ë§ ---
        function updateSummaryAndChart(filteredScores) {
            const userStats = {};
            const chartData = { 'null': 0, 'tie': 0 };

            filteredScores.forEach(row => {
                if (row.user === 'ì—†ìŒ') {
                    chartData['null'] += 1;
                } else if (row.user.includes(', ')) {
                    chartData['tie'] += 1;
                    const users = row.user.split(', ');
                    users.forEach(u => {
                        if (!userStats[u]) userStats[u] = { single: 0, tie: 0 };
                        userStats[u].tie += 1;
                    });
                } else {
                    const u = row.user;
                    chartData[u] = (chartData[u] || 0) + 1;
                    if (!userStats[u]) userStats[u] = { single: 0, tie: 0 };
                    userStats[u].single += 1;
                }
            });

            // ì¢Œì¸¡ ìœ ì € ë¦¬ìŠ¤íŠ¸ DOM ê·¸ë¦¬ê¸° (Tailwind í´ë˜ìŠ¤ ì ìš©)
            const summaryList = document.getElementById("userSummaryList");
            const sortedUsers = Object.keys(userStats).sort((a, b) => {
                return (userStats[b].single + userStats[b].tie) - (userStats[a].single + userStats[a].tie);
            });

            if (sortedUsers.length === 0) {
                summaryList.innerHTML = "<li class='text-slate-400 text-sm p-3'>í•´ë‹¹ ë ˆë²¨ì— íƒ€ì´í‹€ì„ ê°€ì§„ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</li>";
            } else {
                summaryList.innerHTML = sortedUsers.map(user => {
                    const s = userStats[user];
                    const total = s.single + s.tie;
                    const initial = user.substring(0,2).toUpperCase();
                    // ë™ì  í´ë¦­ ì´ë²¤íŠ¸ì™€ í˜¸ë²„ íš¨ê³¼ ì¶”ê°€
                    return `
                    <li class="flex items-center justify-between p-3 bg-slate-50 rounded-xl hover:bg-slate-100 transition border border-transparent hover:border-slate-200">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-white font-bold text-xs shadow-sm">
                                ${initial}
                            </div>
                            <span class="font-medium text-slate-700 cursor-pointer hover:text-brand-500" onclick="setListFilter('user:${user}')">${user}</span>
                        </div>
                        <div class="text-right">
                            <span class="block text-sm font-bold text-brand-500 cursor-pointer" onclick="setListFilter('user:${user}')">${total}ê°œ</span>
                            <span class="text-xs text-slate-400 space-x-1">
                                <span class="cursor-pointer hover:text-slate-600" onclick="setListFilter('single:${user}')">ë‹¨ë… ${s.single}</span> <span class="text-slate-300">|</span> 
                                <span class="cursor-pointer hover:text-slate-600" onclick="setListFilter('tie:${user}')">ê³µë™ ${s.tie}</span>
                            </span>
                        </div>
                    </li>`;
                }).join('');
            }

            drawChart(chartData);
        }

        // ìƒ‰ìƒ í•´ì‹œ í•¨ìˆ˜ ìœ ì§€
        function stringToColor(str, isDimmed) {
            const alpha = isDimmed ? 0.15 : 1.0;
            if (str === 'null') return `rgba(224, 224, 224, ${alpha})`;
            if (str === 'tie') return `rgba(255, 152, 0, ${alpha})`;

            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            const hue = Math.abs(hash % 360);
            return `hsla(${hue}, 70%, 60%, ${alpha})`;
        }

        // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
        function drawChart(dataObj) {
            const ctx = document.getElementById('rankingChart').getContext('2d');
            const labels = Object.keys(dataObj).filter(k => k !== 'tie' && k !== 'null').sort((a, b) => dataObj[b] - dataObj[a]);
            if (dataObj['tie'] > 0) labels.push('tie');
            if (dataObj['null'] > 0) labels.push('null');

            const dataValues = labels.map(l => dataObj[l]);

            const backgroundColors = labels.map(label => {
                let filterCodeForLabel = label;
                if (label !== 'tie' && label !== 'null') filterCodeForLabel = 'single:' + label;

                let isDimmed = true;
                if (currentChartFilter === 'all') isDimmed = false;
                else if (currentChartFilter === filterCodeForLabel) isDimmed = false;
                else if (currentChartFilter.startsWith('user:') && label === currentChartFilter.split(':')[1]) isDimmed = false;
                else if (currentChartFilter.startsWith('tie:') && label === 'tie') isDimmed = false;

                return stringToColor(label, isDimmed);
            });

            if (myChart) {
                myChart.data.labels = labels;
                myChart.data.datasets[0].data = dataValues;
                myChart.data.datasets[0].backgroundColor = backgroundColors;
                myChart.update();
            } else {
                myChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{ data: dataValues, backgroundColor: backgroundColors, borderWidth: 2, borderColor: '#ffffff' }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 8, font: { family: 'Pretendard' } } },
                            tooltip: { callbacks: { label: function(c) { return ` ${c.label}: ${c.raw}ê³¡`; } } }
                        },
                        onClick: (event, elements, chart) => {
                            if (elements.length > 0) {
                                const dataIndex = elements[0].index;
                                const label = chart.data.labels[dataIndex];
                                let filterCode = label;
                                if (label !== 'tie' && label !== 'null') filterCode = 'single:' + label;
                                setListFilter(filterCode);
                            }
                        },
                        onHover: (event, chartElement) => {
                            event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                        },
                        cutout: '70%'
                    }
                });
            }
        }

        // --- ëª¨ë‹¬ ë¡œì§ (ê¸°ì¡´ ìœ ì§€, CSS í´ë˜ìŠ¤ë§Œ Tailwindìš©ìœ¼ë¡œ ë³€ê²½) ---
        async function openModal(song, level) {
            const modal = document.getElementById("rankingModal");
            const title = document.getElementById("modalTitle");
            const tbody = document.getElementById("modalTableBody");

            title.innerText = `${song} (Lv.${level})`;
            tbody.innerHTML = "<tr><td colspan='3' class='py-8 text-center text-slate-500'>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... â³</td></tr>";
            
            // Tailwind flex í‘œì‹œ
            modal.classList.remove("hidden");
            modal.classList.add("flex");

            try {
                const response = await fetch(`/api/ranking?song=${encodeURIComponent(song)}&level=${encodeURIComponent(level)}`);
                const data = await response.json();

                if (data.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='3' class='py-8 text-center text-slate-400'>í”Œë ˆì´ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
                } else {
                    let html = "";
                    let displayRank = 1;
                    let previousScore = -1;

                    data.forEach((item, index) => {
                        if (item.score !== previousScore) { displayRank = index + 1; }
                        previousScore = item.score;

                        const isFirst = displayRank === 1;
                        const rankHtml = isFirst 
                            ? `<span class="bg-amber-100 text-amber-700 font-bold px-2 py-1 rounded">ğŸ¥‡ 1</span>` 
                            : `<span class="text-slate-500 font-medium pl-2">${displayRank}</span>`;

                        html += `
                            <tr class="hover:bg-slate-50 transition">
                                <td class="px-6 py-4 border-b border-slate-50">${rankHtml}</td>
                                <td class="px-6 py-4 border-b border-slate-50"><strong class="text-slate-800">${item.username}</strong></td>
                                <td class="px-6 py-4 border-b border-slate-50 text-right font-mono text-brand-600">${parseFloat(item.score).toFixed(4)}%</td>
                            </tr>
                        `;
                    });
                    tbody.innerHTML = html;
                }
            } catch (e) {
                tbody.innerHTML = "<tr><td colspan='3' class='py-8 text-center text-red-500'>ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>";
            }
        }

        function closeModal(event) {
            const modal = document.getElementById("rankingModal");
            modal.classList.add("hidden");
            modal.classList.remove("flex");
        }
    </script>
</body>
</html>